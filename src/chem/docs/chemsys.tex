\documentclass[aps]{revtex4}
\usepackage{graphicx}
\usepackage{amssymb,amsfonts,amsmath,amsthm}
\usepackage{chemarr}
\usepackage{bm}
\usepackage{bbm}
\usepackage{pslatex}
\usepackage{mathptmx}
\usepackage{xfrac}

\newcommand{\mymat}[1]{\bm{#1}}
\newcommand{\mytrn}[1]{~^{\mathsf{T}}{#1}}
\newcommand{\mygrad}{\vec{\nabla}}

\begin{document}
\title{Chemical Solutions}

\section{Description}
Let us assume that we have $A_1,\ldots,A_M$ chemical species coupled by
$N$ equilibria such that
\begin{equation}
	\forall i \in [1;N], \;\; \sum_{j=1}^{M} \nu_{i,j} C_i = 0, \;\; K_i(t) = \prod_{i=1}^{M} C_i^{\nu_{i,j}}.
\end{equation}
We remove the singularities by assuming that the equilibria are met when
\begin{equation}
	\forall i \in [1;N], \;\; \Gamma_i(t,\vec{C}) = K_i(t) \prod_{\nu_{i,j}<0}  C_i^{-\nu_{i,j}} -  \prod_{\nu_{i,j}>0} C_i^{\nu_{i,j}} 
\end{equation}
or
\begin{equation}
	\vec{\Gamma}(t,\vec{C}) = \vec{0}.
\end{equation}
We also naturally have the topology matrix $\mymat{\nu}$, such that
any chemical shift is defined by a  chemical extent vector $\vec{\xi}$ and
produces a shift
$$
	\mytrn{\mymat{\nu}}\vec{\xi}
$$

\section{Limiting extents}
For each equilibrium, depending on the concentration of each components, a 
maximum and a minimum extent may appear, or may
appear unlimited (i.e. for water).
If both way are blocked, then the equilibrium is blocked.



\section{Chemical balancing}
A transformation may bring some active (aka involved in a reaction) concentrations to a negative value.
Let $\vec{C}$ be a set of concentrations. We define the objective function
$$
	\mathcal{E}(\vec{C}) = \sum_j 
	\left
	\lbrace
		\begin{array}{rl}
		-C_j & \text{if species \#}j\text{ is active and } C_j<0\\
		0    & \text{otherwise.}\\
		\end{array} 
	\right.
$$
The steepest integer descent direction is
$$
	\vec{\beta} = -\vec{\nabla}_{\vec{C}} \mathcal{E} = 
	\left\lbrack
		\begin{array}{c}
		\vdots\\
		\mathbbm{1}_{\text{\#}j=\text{active and } C_j<0}\\
		\vdots
		\end{array}
	\right\rbrack
$$
with translate into an integer descent extent
$$
	\vec{\xi}' = \mymat{\nu} \vec{\beta}.
$$
The extent of the blocked equilibria must be set to zero !\\
Then the integer change of concentration direction is
$$
	\delta\vec{C}' = \mytrn{\mymat{\nu}}\vec{\xi}'.
$$
We must then analyse the maximum step that brings us to the
first zero concentration, while taking care of the addition and subtraction rounding.
If this step is successful, then at least one of the negative species is exactly zero...\\

The use of this $\mathcal{E}$ make a non vanishing $\delta\vec{C}'$.

\section{Newton's algorithm}
Let us start from a balanced concentration $\vec{C}_k$.
We want to find
$$
	\vec{\Gamma}(\vec{C}_k + \mytrn{\mymat{\nu}}\vec{\xi}_k) = \vec{0}.
$$
The first order expansion provides
$$
	\vec{\Gamma}(\vec{C}_k + \mytrn{\mymat{\nu}}\vec{\xi}_k) \simeq 
	\vec{\Gamma}_k + \mymat{\Phi}_k\mytrn{\mymat{\nu}} \vec{\xi}_k
$$
For a valid composition, the Newton's extent is
$$
		\vec{\xi}_k = -\left(\mymat{\Phi}_k\mytrn{\mymat{\nu}}\right)^{-1}\,\vec{\Gamma}_K
$$
which must be clamped to deduce the modified Newton's step
$$
	\delta{\vec{C_k}} = \mytrn{\mymat{\nu}} \vec{\xi}_k^\star
$$
and a careful addition is then performed, avoiding the roundoff errors.

\section{Booting Algorithm}
We have $M$ species, $N$ equilibria, 
so we must have $M\geq N$ and $Nc=M-N$ other conditions
to obtain a starting value.
Let us assume that we deal only with linear constraints (electroneutrality, mass conservation...).
This may be written in terms of an integer matrix $\mymat{P}$
such that
$$
	\mymat{P}\vec{C} = \vec{\Lambda}.
$$
To be able to find a solution, the matrix $\mymat{P}\oplus\mymat{\nu}$ must
be not singular, with allows the computation of an orthogonal (integer) matrix
$$
	\mymat{Q},\;\mytrn{\mymat{P}}\cdot\mymat{Q} = \mymat{0},\;Q\in\mathcal{M}_{N,M}.
$$
Hence, starting from a valid concentration $\vec{C}_k$, we want to compute
$$
	\vec{\Gamma}
	\left(
		\vec{C}_k+\mytrn{\mymat{P}}\delta\vec{U}_k + \mytrn{\mymat{Q}}\vec{\xi}_k
		\right) = \vec{0}.
$$
We compute $\vec{\Gamma}_k$ and $\mymat{\Phi}_k$. Then we
compute
$$
	\vec{C}_k' = \vec{C}_k + \mytrn{\mymat{P}}\left(\mymat{P}\mytrn{\mymat{P}}\right)^{-1}\left(\vec{\Lambda}-\mymat{P}\vec{C}_k\right)
$$
and we deduce
$$
	\vec{\xi}_k = -\left(\mymat{\Phi}\mytrn{\mymat{Q}}\right)^{-1}\left(\vec{\Gamma}_k+\mymat{\Phi}_k \vec{C}_k'\right)
$$

\section{Generic Balancing Algorithm}
We define an objective function
$$
	\mathcal{E}(\vec{C}) = \sum_{j\in\mathrm{active}} -C_j \mathbbm{1}_{C_j\leq0}
$$
which is positive if an active species has an invalid concentration.
The integer descent direction is
$$
	\vec{\beta} = - \vec{\nabla}_{\vec{C}} \mathcal{E} = 
	\begin{bmatrix}
		\vdots\\
		\mathbbm{1}_{C_{j\in\mathrm{active}}\leq0}\\
		\vdots
	\end{bmatrix}
$$
It is very important to take into account the zero concentration for they
represent a stopping point or a cancellation for the evolution.

Let us assume that we want to minimise this function using an integer matrix $\mymat{Q}$
$$
	\vec{C}_{k+1} = \vec{C}_k + \mytrn{\mymat{Q}}\vec{V}_k
$$
then the descent direction $\vec{\xi}_k'$ for $\vec{V}$ is
$$
		\vec{\xi}'_k = \mymat{Q} \vec{\beta}_k
$$
and the integer descent direction for $\vec{C}_k$ is
$$
	\vec{U}_k = \mytrn{\mymat{Q}} \vec{\xi}'_k = \mytrn{\mymat{Q}} \mymat{Q} \vec{\beta}_k
$$

\end{document}