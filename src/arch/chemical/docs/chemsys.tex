\documentclass[aps]{revtex4}
\usepackage{graphicx}
\usepackage{amssymb,amsfonts,amsmath,amsthm}
\usepackage{chemarr}
\usepackage{bm}
\usepackage{bbm}
\usepackage{pslatex}
\usepackage{mathptmx}
\usepackage{xfrac}

\newcommand{\mymat}[1]{\bm{#1}}
\newcommand{\mytrn}[1]{~^{\mathsf{T}}{#1}}
\newcommand{\mygrad}{\vec{\nabla}}

\begin{document}
\title{Chemical Solutions}

\section{Description}
Let us assume that we have $A_1,\ldots,A_M$ chemical species coupled by
$N$ equilibria such that
\begin{equation}
	\forall i \in [1;N], \;\; \sum_{j=1}^{M} \nu_{i,j} C_i = 0, \;\; K_i(t) = \prod_{i=1}^{M} C_i^{\nu_{i,j}}.
\end{equation}
We remove the singularities by assuming that the equilibria are met when
\begin{equation}
	\forall i \in [1;N], \;\; \Gamma_i(t,\vec{C}) = K_i(t) \prod_{\nu_{i,j}<0}  C_i^{-\nu_{i,j}} -  \prod_{\nu_{i,j}>0} C_i^{\nu_{i,j}} 
\end{equation}
or
\begin{equation}
	\vec{\Gamma}(t,\vec{C}) = \vec{0}.
\end{equation}
We also naturally have the topology matrix $\mymat{\nu}$.

\section{Acceptable Extent}
Each reaction, depending on the initial concentrations, may have a maximum extent in the forward and/or the reverse way.
A negative or zero concentration blocks one way. The equilibrium is blocked when both ways are blocked.
In any case, each equilibrium imposes a range of valid extent.
Any chemical transformation is deduced from $\vec{C}$ and a chemical extent $\vec{\xi}$ by
$$
	\vec{C} + \mytrn{\mymat{\nu}}\vec{\xi}.
$$

\section{Validation a set of concentration}
A trial concentration vector $\vec{C}_k$ may be invalid: an \textbf{active} species (namely a species involved in an equilibria)
may be negative. In that case, we must look for the minimal extent that brings back the concentrations to a valid set, if that
is possible.
Let $Q$ be the number of online (aka not blocked) reactions corresponding 
to the online $Q$-dimensional extent $\vec{\xi}'$. We also have a set of $B$ 'bad' concentrations (active and negative) $\vec{C}'$.
Thus we search $\vec{\xi}'$ such that
$$
	\vec{C}' + \mymat{\beta} \vec{\xi}' = \vec{0}
$$
where $\beta$ is a $B\times Q$ matrix corresponding to a sub-matrix of $\mytrn{\mymat{\nu}}$.
We can this this last vectorial equation as a set of $B$ constraints. Thus we define a set
$\vec{\lambda}$ of $B$ Lagrange multipliers and we minimise
$$
	\dfrac{1}{2} \vec{\xi}'^2 - \vec{\lambda}\cdot\left(\vec{C}' + \mymat{\beta} \vec{\xi}'\right)
$$
leading to
$$
	\vec{\xi}' = \mytrn{\mymat{\beta}}\vec{\lambda}
$$
The Lagrange multipliers are given by
$$
	\mymat{\beta}\mytrn{\mymat{\beta}} \vec{\lambda} = -\vec{C}'
$$
If the Gramian matrix 
$$
	\mymat{J} = \mymat{\beta}\mytrn{\mymat{\beta}}
$$	
is not invertible, then the system cannot be normalised.
Otherwise, we can compute $\vec{\lambda}$ then 
$\vec{\xi}'$.
A full extent $\vec{\xi}$ can be deduced from $\vec{\xi}'$.
The we must deduce the concentration increase, taking into account the acceptable extents,
and numerical roundoff.
Especially, since $\vec{\xi}$ is optimised and clipped,
\begin{itemize}
\item a negative concentration can never become strictly positive
\item a positive concentration can never become strictly negative.
\end{itemize}
                 

\section{Finding some equilibria}

Let us assume that we start from a valid but out-of-equilibrium state $\vec{C}$.
Then the system can evolve only by a $N$ dimensional chemical advancement $\vec{\xi}$
\begin{equation}
	\vec{C}_{eq} = \vec{C} + \mytrn{\mymat{\nu}}\vec{\xi}
\end{equation}
Starting from a value $\vec{C}_{k}$, the Newton algorithm yields
\begin{equation}
	\vec{0} = \vec{\Gamma}(t,\vec{C}_k) + \mymat{\Phi}(t,\vec{C}_k) \mytrn{\mymat{\nu}}\vec{\xi}_k
\end{equation}
Here, the extent has to be clipped to be acceptable.


\section{Absorbing a perturbation}
We start from time $t$ and make a perturbation $\delta\vec{C}$ to a valid set of concentration $\vec{C}$ such that 
$\vec{\Gamma}(t,\vec{C})=\vec{0}$.
The instantaneous extent $\delta\vec{\xi}$ relaxes to 
$$
\vec{\Gamma}(t+\delta t,\vec{C}+\delta\vec{C}+\mytrn{\mymat{\nu}}\delta\vec{\xi}) = \vec{0}.
$$
The first order expansion
is
$$
	\vec{0} = \delta t \partial_t \vec{\Gamma} + \mymat{\Phi}\left( \delta\vec{C} + \mytrn{\mymat{\nu}}\delta\vec{\xi} \right)
$$
then
$$
	\delta\vec{\xi} = -\left(\mymat{\Phi}\mytrn{\mymat{\nu}}\right)^{-1}\left(\mymat{\Phi}\delta\vec{C}+\delta t \partial_t\vec{\Gamma}\right).
$$
For a given rate $\delta\vec{C} = \vec{\rho} \delta t$, we have an effective rate
$$
	\vec{\rho}' = \vec{\rho} -  \mytrn{\mymat{\nu}}\left(\mymat{\Phi}\mytrn{\mymat{\nu}}\right)^{-1}\left(\mymat{\Phi}\vec{\rho}+\partial_t\vec{\Gamma}\right)
$$

\section{Initial compositions}
Since we have $M$ species and $N$ relations to match, we need
a set of $R=M-N$ other relations to find determine a unique set of concentrations.
We assume that all those relations (electroneutrality, mass conservation, constant concentrations)
may we written as a $R\times M$ matrix $\mymat{P}$ such that
$$
	\mymat{P}\vec{C} = \vec{\Lambda}.
$$
This means that any concentration may be written as
$$
	\vec{C} = \vec{C}^\star + \mytrn{\mymat{P}} \vec{U} + \mytrn{\mymat{Q}} \vec{V}
$$
with
$$
	\vec{C}^\star = \mytrn{\mymat{P}} \left(\mymat{P}\mytrn{\mymat{P}}\right)^{-1}\vec{\Lambda}
$$
and $\mymat{Q}$ is a matrix whose rows are orthogonal to the rows of $\mymat{P}$.\\
Since $\mymat{P}$ and $\mymat{\nu}$ must be a base of $\mathbb{R}^{M}$ (otherwise $\mymat{P}$ is invalid), we can 
use an integer version of the Gram-Schmidt's orthogonalisation to find $\mymat{Q}$.
Starting from 
$$
	\vec{C}_k = \vec{C}^\star + \mytrn{\mymat{P}} \vec{U}_k + \mytrn{\mymat{Q}} \vec{V}_k
$$
we want to find $\vec{C}_{k+1}$ such that
$$
	\vec{\Gamma}(\vec{C}_{k+1}) \simeq \vec{0}.
$$
The respect of the contraints imposes
$$
	\delta\vec{X}_k = \mytrn{\mymat{P}} 
	\left(\mymat{P}\mytrn{\mymat{P}}\right)^{-1} \left(\vec{\Lambda} - \mymat{P}\vec{C}_k\right).
$$
Now we expand
$$
	\vec{\Gamma}\left(\vec{C}_{k+1}\right) \simeq \vec{\Gamma}_k + \mymat{\Phi}_k\left(\delta\vec{X}_k+\mytrn{\mymat{Q}} \delta\vec{V}_k\right)
$$
and find
$$
	\delta\vec{Y}_k = -\mytrn{\mymat{Q}} \left(\mymat{\Phi}_k\mytrn{\mymat{Q}}\right)^{-1} \left(\vec{\Gamma}_k+\mymat{\Phi}_k \delta\vec{X}_k\right).
$$
The total Newton's step is $\delta\vec{C}_k=\delta\vec{X}_k+\delta\vec{Y}_k$.\\
Numerically,
$$
	\mymat{P}\vec{C}_{k+1} = \vec{\Lambda}.
$$
Under this assumption, the convergence has to be tested on a $\mymat{Q}$-only step.


\end{document}