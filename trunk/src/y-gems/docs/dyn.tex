\documentclass[aps,twocolumn]{revtex4}
\usepackage{graphicx}
\usepackage{amssymb,amsfonts,amsmath}
\usepackage{chemarr}
\usepackage{bm}
\usepackage{pslatex}
%\usepackage{mathptmx}
\usepackage{xfrac}

%% concentration notations
\newcommand{\mymat}[1]{\boldsymbol{#1}}
%\newcommand{\mytrn}[1]{{#1}^{\mathrm{t}}}
\newcommand{\mytrn}[1]{{\!\!~^{\mathsf{t}}{#1}}}
\newcommand{\myvec}[1]{\overrightarrow{#1}}
\newcommand{\half}{\sfrac{1}{2}}

\begin{document}
\title{Dynamics}

\section{Notations}
Let us have a system with $N$ particles, so that we have a $3N$-dimensional
vector $\vec{q}$ of positions and a vector $\vec{v}$ of velocities.
We assume that we can compute the force field $\vec{F}$ such that
\begin{equation}
	\vec{a} = \mymat{W} \vec{F}
\end{equation}
where $\mymat{W}$ is the tensorized mass inverse matrix.

\section{Newtonian Dynamics}

\subsection{Problem}
At step $n$, we know $\vec{q}_n$, $\vec{v}_n$ and $\vec{a}_n = \mymat{W} \vec{F}_n$.
How do we compute $\vec{q}_{n+1}$ after a time step $\tau$ ?

\subsection{Velocity Verlet}
This is a two steps mechanism.
\begin{enumerate}
	\item
	Compute $\vec{a}_n = \mymat{W} \vec{F}_n$ then 
	upgrade the positions and the velocities with
	\begin{align}
	\vec{v}_{n+\half} & = \vec{v}_{n} + \dfrac{1}{2} \tau \vec{a}_n \\
	\vec{q}_{n+1}           & = \vec{q}_{n}       + \tau \vec{v}_{n} + \dfrac{1}{2}{\tau^2} \vec{a}_n
	\end{align}

	\item 
	Evaluate $\vec{a}_{n+\half} = \mymat{W} \vec{F}_{n+\half}$  using $\vec{v}_{n+\half}$ and $\vec{q}_{n+1}$ 
	then complete
	\begin{equation}
		\vec{v}_{n+1} = \vec{v}_{n+\half} + \dfrac{1}{2} \tau \vec{a}_{n+\half}
	\end{equation}

\end{enumerate}

For conservative systems, the Velocity Verlet algorithm is precise to the order 2, and there is
no need to re-compute the forces after the velocity completion step.

\section{Holomorphic Constraints}
\subsection{Continuous description}
\subsubsection{Legal positions}

Let us assume that we have a set of $M$ holomorphic constraints, namely we want
\begin{equation}
	\label{eq:C}
	\vec{C}\left(\vec{q}\right) = \vec{0}.
\end{equation}

\subsubsection{Legal velocities}
Accordingly, the time derivatives of Eq. \eqref{eq:C} are all zero.
Especially
\begin{equation}
	\label{eq:J}
	\mymat{J}\vec{v} = \vec{0}
\end{equation}
where $\mymat{J}$ is the $M\times 3N$ Jacobian of $\vec{C}$ with respect to $\vec{q}$.
The Eq. \eqref{eq:J} already defines a set of \textbf{legal} velocities.

\subsubsection{Legal dynamics}
We assume that the set of constraints produces a set of internal forces $\vec{G}$ so that
\begin{equation}
	\vec{a} = \mymat{W} \left( \vec{F} + \vec{G} \right).
\end{equation}
The derivative of Eq. \eqref{eq:J} yields
\begin{equation}
	\vec{0} = \dot{\mymat{J}}\vec{v} + \mymat{J}\vec{a}
\end{equation}
where
\begin{equation}
	\dot{\mymat{J}} = \partial_{\vec{q}} \dot{\vec{C}}
\end{equation}
is the Jacobian of $\dot{\vec{C}}$ with respect to $\vec{q}$.

We end up with
\begin{equation}
\label{eq:JW}
	\mymat{J}\mymat{W}\vec{G} = 
	-\mymat{J}\mymat{W}\vec{F} - \dot{\mymat{J}}\vec{v}
\end{equation}

\subsubsection{Not Working Constraints}
Since the virtual forces are not working, they must be orthogonal to the legal velocities: the Eq. \eqref{eq:J}
shows that they are a linear combination of the rows of $\mymat{J}$.
There exists a $M$ dimensional vector $\vec{\lambda}$ 
of Lagrange multipliers
such that
\begin{equation}
	\vec{Y} = \mytrn{\mymat{J}}\vec{\lambda}.
\end{equation}

Using Eq. \eqref{eq:JW}, one finds
\begin{equation}
	\mymat{J}\mymat{W} \mytrn{\mymat{J}}\vec{\lambda} = -\left(\mymat{J}\mymat{W}\vec{F} + \dot{\mymat{J}}\vec{v}\right)
\end{equation}
and finally
\begin{equation}
	\vec{G} = - \mytrn{\mymat{J}}\left(\mymat{J}\mymat{W} \mytrn{\mymat{J}}\right)^{-1}\left(\mymat{J}\mymat{W}\vec{F} + \dot{\mymat{J}}\vec{v}\right)
\end{equation}

\subsection{Discrete description}

We modify the Velocity Verlet algorithm.
We start from
$$
	\vec{C}(\vec{q}_n)=\vec{0}  
$$
and
$$
 \mymat{J}_n \vec{v}_n = \vec{0}
$$
and we evaluate the extern forces $\vec{F}_n$.



\end{document}
