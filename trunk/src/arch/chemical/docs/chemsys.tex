\documentclass[aps,twocolumn]{revtex4}
\usepackage{graphicx}
\usepackage{amssymb,amsfonts,amsmath,amsthm}
\usepackage{chemarr}
\usepackage{bm}
\usepackage{pslatex}
\usepackage{mathptmx}
\usepackage{xfrac}

%% concentration notations
\newcommand{\myconc}[1]{\left\lbrack #1 \right\rbrack}
\newcommand{\mychem}[1]{{\mathtt{#1}}}
\newcommand{\species}{\mychem{X}}
\newcommand{\mymat}[1]{\boldsymbol{#1}}
%\newcommand{\mytrn}[1]{{#1}^{\mathrm{t}}}
\newcommand{\mytrn}[1]{{\!\!~^{\mathsf{t}}{#1}}}
\newcommand{\myvec}[1]{\overrightarrow{#1}}
\newcommand{\vecX}{\myvec{\myconc{\mychem{X}}}}
\newcommand{\fixed}{\mathtt{f}}
\newcommand{\kernel}{\mathtt{k}}
\newcommand{\proj}{\mathtt{p}}

\begin{document}
\title{Chemical Solution}


\maketitle
%\tableofcontents

\section{Chemical system Equilibria}
\subsection{Formal Description}
If we assume that we have $N$ chemical reactions coupling $M$ species $\species_{1,\ldots,M}$ then those reactions can be classically written with the help
of the \textit{algebraic} stoichiometric coefficients matrix $\mymat{\nu}$ as
\begin{equation}
	\label{eq:Ki}
	\forall i \in 1..N, \; \sum_{j\in1..M} \mymat{\nu}_{i,j} \species_j = 0, \; K_i=\prod_{j\in1..M} \myconc{\species_j}^{\mymat{\nu}_{i,j}}
\end{equation}
where $K_i$ is the equilibrium constant of the i$^{\text{th}}$ reaction\\
Accordingly we can define the vector $\vec{\Gamma}$ such that its coordinate ${\Gamma}_i$ is
\begin{equation}
	\label{eq:Gamma}
	\forall i \in 1..N, {\Gamma}_i =  \left( K_i \prod_{\mymat{\nu}_{i,j}<0} \myconc{\species_j}^{-\nu_{i,j}} - \prod_{\mymat{\nu}_{i,j}>0} \myconc{\species_j}^{\nu_{i,j}}\right) = 0.
\end{equation}

The Jacobian matrix of $\vec{\Gamma}$ is
\begin{equation}
	\partial_{\vecX} \vec{\Gamma} = \mymat{\Phi}
\end{equation}
The $N$ equilibria allow a vector of corresponding chemical extent $\delta\vec{\xi}$ such that any increase of concentrations is
\begin{equation}
	\delta\vecX = \mytrn{\mymat{\nu}} \delta\vec{\xi}
\end{equation}

\subsection{Valid Equilibria: Newton Algorithm Mark-I}
\subsubsection{Algebraic Method}

Let us assume that we have a set of concentration $\vecX_{n}$ and that we look for an evolution $\delta\vec{\xi}_{n}$.
\begin{equation}
	\vec{\Gamma}\left(\vecX_{n}+\delta\vecX_{n}\right) \simeq \vec{\Gamma}_{n} + \mymat{\Phi}_n \mytrn{\mymat{\nu}} \delta\vec{\xi}_n
\end{equation}
For a valid set of concentrations (all greater of equal to zero, one not zero), the matrix $\mymat{\Phi}_n \mytrn{\mymat{\nu}}$ is invertible
and
\begin{equation}
	\delta\vec{\xi}_n = -\left(\mymat{\Phi}_n \mytrn{\mymat{\nu}}\right)^{-1} \vec{\Gamma}_{n}
\end{equation}
so that the concentration increase is
\begin{equation}
	\delta\vecX_{n} = - \mytrn{\mymat{\nu}}\left(\mymat{\Phi}_n \mytrn{\mymat{\nu}}\right)^{-1} \vec{\Gamma}_{n}
\end{equation}
and
\begin{equation}
	\vecX_{n+1} = \vecX_{n} + \delta\vecX_{n}.
\end{equation}
This Newton step is to be repeated until
\begin{equation}
	\forall i, \; \vert\delta\vecX_{n,i}\vert \leq \epsilon \times \vert\vecX_{n+1,i}\vert
\end{equation}

\subsubsection{Numerical Problems/Cutoffs}
The idea is to not allow the Newton's step to set a negative concentration.
Different strategies can be implemented.



\section{Chemical System Initialization}
\subsection{Description}
We assume that we have $N_c$ linear constraints, that reflects that some quantities are conserved: mass, charge.
Firstly, we assume that $N_c+N=M$, which is \textbf{necessary} to have a solution.

\subsection{Cleanup}
We divide the solutions in two classes:
\begin{enumerate}
	\item The $\fixed$ "fixing" conditions, so that the solution are of the form
	$$
		\vecX = \vecX_0 + \mymat{\Psi} \vec{Y}
	$$
	with $\vec{Y}\in\mathbb{R}^{M-f}$ and $\Psi\in\mathcal{M}_{M,M-f}$ is an orthogonal matrix with only one
	unit term per column, corresponding to the not fixed concentrations.

	\item The $\proj$ "projection" condition so that
	$$
		\mymat{P}\vecX = \myvec{\Lambda}	
	$$
	with $\mymat{P}\in\mathcal{M}_{\proj,M}$.
	 Each row of $\mymat{P}$ has at least two 
	values which are not zero.
\end{enumerate}

\begin{quote}
\centerline{\textbf{Warning !}}
A work must be done to ensure that for any fixed species, the corresponding coefficient for
each row of $\mymat{P}$  is zero !!!
\end{quote}

\subsection{Biased Chemistry}
While we evaluate $\vec{\Gamma}$ with the normal topology matrix $\mymat{\nu}$, we must use
the biased topology matrix $\tilde{\mymat{\nu}}$ where all the coefficients corresponding to the
fixed concentrations are set to zero, and the biased jacobian $\tilde{\mymat{\Phi}}$ where
all the columns corresponding to the fixed concentrations are set to zero.

\subsection{Restriction}
The final condition is
$$
	\mymat{P}\vecX_0 + \mymat{P}\mymat{\Psi} \vec{Y} = \vec{\Lambda} = \mymat{P}\vecX_0 + \mymat{\alpha} \vec{Y}.
$$
Let $\mymat{\beta}\in\mathcal{M}_{N,M-f}$ such that $\mytrn{\mymat{\beta}} \in \mytrn{\mymat{\alpha}}^\perp$.
So we have a set Lagrange multipliers $\vec{U}\in\mathbb{R}^{p}$ and $\vec{V}\in\mathbb{R}^{N}$
$$
	\vec{Y} = \mytrn{\mymat{\alpha}}\vec{U} + \mytrn{\mymat{\beta}}\vec{V}.
$$
The projection condition leads to
$$
	\mymat{\alpha}\mytrn{\mymat{\alpha}}\vec{U} = \vec{\Lambda} - \mymat{P}\vecX_0
$$
and finally
$$
	\vecX = \underbrace{\vecX_0 + \mymat{\Psi} \mytrn{\mymat{\alpha}}\left(\mymat{\alpha}\mytrn{\mymat{\alpha}}\right)^{-1}\left(\vec{\Lambda} - \mymat{P}\vecX_0\right)}_{\vec{X}^\star}
	+\underbrace{\mymat{\Psi}\mytrn{\mymat{\beta}}}_{\mytrn{\mymat{\Theta}}}\vec{V}.
$$
By construction,
$$
	\mymat{\Theta} = \mymat{\beta}\mytrn{\mymat{\Psi}} \Rightarrow \mymat{\Theta}\mytrn{\mymat{\Theta}} = \mymat{I}_N.
$$
Since $\mytrn{\mymat{\Psi}}\vecX_0 = \vec{0}$, 
$$
		\mymat{\Theta} \vec{X}^\star = \vec{0}.
$$

We know have to find $\vec{V}$ such that
$$
	\vec{\Gamma}(\vec{X}^\star + \mytrn{\mymat{\Theta}}\vec{V}) = \vec{0}
$$
\end{document}

\end{document}
