\documentclass[aps,twocolumn]{revtex4}
\usepackage{graphicx}
\usepackage{amssymb,amsfonts,amsmath,amsthm}
\usepackage{chemarr}
\usepackage{bm}
\usepackage{pslatex}
\usepackage{mathptmx}
\usepackage{xfrac}

%% concentration notations
\newcommand{\myconc}[1]{\left\lbrack #1 \right\rbrack}
\newcommand{\mychem}[1]{{\mathtt{#1}}}
\newcommand{\species}{\mychem{X}}
\newcommand{\mymat}[1]{\boldsymbol{#1}}
%\newcommand{\mytrn}[1]{{#1}^{\mathrm{t}}}
\newcommand{\mytrn}[1]{{\!\!~^{\mathsf{t}}{#1}}}
\newcommand{\myvec}[1]{\overrightarrow{#1}}
\newcommand{\vecX}{\myvec{\myconc{\mychem{X}}}}
\newcommand{\dof}{\mathtt{d}}
\newcommand{\fixed}{\mathtt{f}}
\begin{document}
\title{Chemical Solution}


\maketitle
%\tableofcontents

\section{Chemical system Equilibria}
\subsection{Formal Description}
If we assume that we have $N$ chemical reactions coupling $M$ species $\species_{1,\ldots,M}$ then those reactions can be classically written with the help
of the \textit{algebraic} stoichiometric coefficients matrix $\mymat{\nu}$ as
\begin{equation}
	\label{eq:Ki}
	\forall i \in 1..N, \; \sum_{j\in1..M} \mymat{\nu}_{i,j} \species_j = 0, \; K_i=\prod_{j\in1..M} \myconc{\species_j}^{\mymat{\nu}_{i,j}}
\end{equation}
where $K_i$ is the equilibrium constant of the i$^{\text{th}}$ reaction\\
Accordingly we can define the vector $\vec{\Gamma}$ such that its coordinate $\vec{\Gamma}_i$
\begin{equation}
	\label{eq:Gamma}
	\forall i \in 1..N, \vec{\Gamma}_i = K_i \prod_{\mymat{\nu}_{i,j}<0} \myconc{\species_j}^{-\nu_{i,j}} - \prod_{\mymat{\nu}_{i,j}>0} \myconc{\species_j}^{\nu_{i,j}} = 0.
\end{equation}
The Jacobian matrix of $\vec{\Gamma}$ is
\begin{equation}
	\partial_{\vecX} \vec{\Gamma} = \mymat{\Phi}
\end{equation}
The $N$ equilibria allow a vector of corresponding chemical extent $\delta\vec{\xi}$ such that any increase of concentrations is
\begin{equation}
	\delta\vecX = \mytrn{\mymat{\nu}} \delta\vec{\xi}
\end{equation}

\subsection{Valid Equilibria: Newton Algorithm Mark-I}
\subsubsection{Algebraic Method}

Let us assume that we have a set of concentration $\vecX_{n}$ and that we look for an evolution $\delta\vec{\xi}_{n}$.
\begin{equation}
	\vec{\Gamma}\left(\vecX_{n}+\delta\vecX_{n}\right) \simeq \vec{\Gamma}_{n} + \mymat{\Phi}_n \mytrn{\mymat{\nu}} \delta\vec{\xi}_n
\end{equation}
For a valid set of concentrations (all greater of equal to zero, one not zero), the matrix $\mymat{\Phi}_n \mytrn{\mymat{\nu}}$ is invertible
and
\begin{equation}
	\delta\vec{\xi}_n = -\left(\mymat{\Phi}_n \mytrn{\mymat{\nu}}\right)^{-1} \vec{\Gamma}_{n}
\end{equation}
so that the concentration increase is
\begin{equation}
	\delta\vecX_{n} = - \mytrn{\mymat{\nu}}\left(\mymat{\Phi}_n \mytrn{\mymat{\nu}}\right)^{-1} \vec{\Gamma}_{n}
\end{equation}
and
\begin{equation}
	\vecX_{n+1} = \vecX_{n} + \delta\vecX_{n}.
\end{equation}
This Newton step is to be repeated until
\begin{equation}
	\forall i, \; \vert\delta\vecX_{n,i}\vert \leq \epsilon \times \vert\vecX_{n+1,i}\vert
\end{equation}

\subsubsection{Numerical Problems/Cutoffs}
We have to control the small concentrations and the small increase of concentration.
Let us assume that $\tilde\epsilon$ is near the numerical zero. Then any concentration under this value
should be set to zero. 


\section{Chemical System Initialization}
\subsection{Remaining Degrees of Freedom}
\subsubsection{Discriminating between constraints}
We need $M-N$ supplementary relations to initialize the system. Hopefully, this constraint should be linear
since they shall express the matter conservation, the charge conservation or a fixed concentration.
We have
$$
	N_c  = M-N.
$$
Among those $N_c$ constraints, we isolate the $\fixed$ "single" component condition that fix $\fixed$ concentrations.
We have $\dof$ remaining degrees of freedom with
$$
	\fixed + \dof = N_c.
$$
\subsubsection{Fixed solution}
Let $\vecX_0$ be the vector of fixed concentrations corresponding to the $\fixed$ single constraints, and with
a zero values otherwise.
	
Since $\fixed$ concentrations are fixed, we define the stoichiometric matrix $\hat{\mymat{\nu}}$
where the coefficients of all the fixed species are set to zero, and equal to those of $\mymat{\nu}$ otherwise.
Consequently, all the columns or $\mymat{\Phi}$ corresponding to the fixed concentrations must 
be set to zero to form the $\hat{\mymat{\Phi}}$ matrix. 
But $\vec{\Gamma}$ (and the other terms of $\mymat{\Phi}$) must be evaluated with
the untouched $\mymat{\nu}_r$ and $\mymat{\nu}_p$.

\subsubsection{Remaining linear constraints}
We are left with a matrix $\mymat{P}\in\mathcal{M}_{\dof,M}$ and a vector $\vec{\Lambda}\in\mathbb{R}^{\dof}$ such
that the acceptable set of concentration must match
\begin{equation}
	\mymat{P}\vecX = \vec{\Lambda}
\end{equation}

\subsection{Particular Cases}
\subsubsection{No Reactions}
In that case, $\mymat{P}$ is a square matrix which must be invertible.
We get
$$
	\vecX = \mymat{P}^{-1}\vec{\Lambda}
$$
and we must check that the concentrations are OK.

\subsubsection{No extra degrees of freedom}
In that case, we start from a random set of concentrations, but for the fixed values, and
we apply the Newton's algorithm with $\hat{\mymat{\nu}}$.

\subsection{Generic Case}
\subsubsection{Reference Term}
If $\fixed$ concentration are fixed, then there exist a othonormal matrix $\mymat{A}\in\mathcal{M}_{M-d,M}$ and
a set a Lagrange multipliers $\vec{Y}_0\in\mathbb{R}^{M-d}$ such that the solution may be written
\begin{equation}
	\vecX = \vecX_0 + \mytrn{\mymat{A}}\vec{Y}_0 + \ldots
\end{equation}
Each row of $\mymat{A}$ is zero but for one element corresponding to the index of a non fixed concentration.
The vector $\vec{Y}_0$ is defined by
$$
	\mymat{P}\left(\vecX_0+\mytrn{\mymat{A}}\vec{Y}_0\right) = \vec\Lambda.
$$
We define
$$
	\mymat{\Psi} = \mymat{P}\mytrn{\mymat{A}}
$$
and deduce that
$$
	\vec{Y}_0 = \mytrn{\mymat{\Psi}} \left(\mymat{\Psi} \mytrn{\mymat{\Psi}}\right)^{-1}\left( \vec{\Lambda} - \mymat{P}\vecX_0\right).
$$
We recognise the Moore-Penrose pseudo-inverse of $\mymat{\Psi}$. If the Gram matrix of $\mymat{\Psi}$ is not invertible then
the constraints are not valid.

\subsubsection{Acceptable Solutions}
Let $\mytrn{\mymat{Q}}$ be an orthonormal base of $\mytrn{\mymat{P}}^\perp$. Then any acceptable solution must be in
$$
	\mathrm{im}(\mytrn{\mymat{A}}) \cap \mathrm{im}(\mytrn{\mymat{Q}}).
$$
We note $\mytrn{\mymat{B}}$ the trivial orthonormal base of  $\mytrn{\mymat{A}}^\perp$ (which may be empty)
and see that and acceptable solution must be in
$$
	\left( 
	\mathrm{im}(\mytrn{\mymat{B}})
	\cup
	\mathrm{im}(\mytrn{\mymat{P}})
	\right)^\perp
$$
\end{document}


\subsubsection{Final Error Estimation}
Let $\vecX_n$ the set of current values. The the error is about
\begin{equation}
	\delta \vecX_n = \mytrn{\mymat{Q}}\left(\mymat{\Phi}_n\mytrn{\mymat{Q}}\right)^{-1} \vec{\Gamma}_n
\end{equation}
This shall provide the cutoff for small concentrations.


\end{document}
