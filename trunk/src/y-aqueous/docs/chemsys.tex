\documentclass[aps,twocolumn]{revtex4}
\usepackage{graphicx}
\usepackage{amssymb,amsfonts,amsmath,amsthm}
\usepackage{chemarr}
\usepackage{bm}
\usepackage{pslatex}
\usepackage{mathptmx}
\usepackage{xfrac}

%% concentration notations
\newcommand{\myconc}[1]{\left\lbrack #1 \right\rbrack}
\newcommand{\mychem}[1]{{\mathtt{#1}}}
\newcommand{\species}{\mychem{X}}
\newcommand{\mymat}[1]{\boldsymbol{#1}}
%\newcommand{\mytrn}[1]{{#1}^{\mathrm{t}}}
\newcommand{\mytrn}[1]{{\!\!~^{\mathsf{t}}{#1}}}
\newcommand{\myvec}[1]{\overrightarrow{#1}}
\newcommand{\vecX}{\myvec{\myconc{\mychem{X}}}}

\begin{document}
\title{Chemical Aqueous System}

\maketitle
%\tableofcontents

\section{Chemical system Evolution}
\subsection{Formal Description}
If we assume that we have $N$ chemical reactions coupling $M$ species $\species_{1,\ldots,M}$ then those reactions can be classically written with the help
of the \textit{algebraic} stoichiometric coefficients matrix $\mymat{\nu}$ as
\begin{equation}
	\label{eq:Ki}
	\forall i \in 1..N, \; \sum_{j\in1..M} \mymat{\nu}_{i,j} \species_j = 0, \; K_i=\prod_{j\in1..M} \myconc{\species_j}^{\mymat{\nu}_{i,j}}
\end{equation}
where $K_i$ is the equilibrium constant of the i$^{\text{th}}$ reaction\\
Accordingly we can define the vector $\vec{\Gamma}$ such that its coordinate $\vec{\Gamma}_i$
\begin{equation}
	\label{eq:Gamma}
	\forall i \in 1..N, \vec{\Gamma}_i = K_i \prod_{\mymat{\nu}_{i,j}<0} \myconc{\species_j}^{-\nu_{i,j}} - \prod_{\mymat{\nu}_{i,j}>0} \myconc{\species_j}^{\nu_{i,j}} = 0.
\end{equation}
The Jacobian matrix of $\vec{\Gamma}$ is
\begin{equation}
	\partial_{\vecX} \vec{\Gamma} = \mymat{\Phi}
\end{equation}
The $N$ equilibria allow a vector of corresponding chemical extent $\delta\vec{\xi}$ such that any increase of concentrations is
\begin{equation}
	\delta\vecX = \mytrn{\mymat{\nu}} \delta\vec{\xi}
\end{equation}

\subsection{Matching Equilibria: Newton Algorithm Mark-I}
Let us assume that we have a set of concentration $\vecX_{n}$ and that we look for an evolution $\delta\vec{\xi}_{n}$.
\begin{equation}
	\vec{\Gamma}\left(\vecX_{n}+\delta\vecX_{n}\right) \simeq \vec{\Gamma}_{n} + \mymat{\Phi}_n \mytrn{\mymat{\nu}} \delta\vec{\xi}_n
\end{equation}
For a valid set of concentrations (all greater of equal to zero, one not zero), the matrix $\mymat{\Phi}_n \mytrn{\mymat{\nu}}$ is invertible
and
\begin{equation}
	\delta\vec{\xi}_n = -\left(\mymat{\Phi}_n \mytrn{\mymat{\nu}}\right)^{-1} \vec{\Gamma}_{n}
\end{equation}
so that the concentration increase is
\begin{equation}
	\delta\vecX_{n} = - \mytrn{\mymat{\nu}}\left(\mymat{\Phi}_n \mytrn{\mymat{\nu}}\right)^{-1} \vec{\Gamma}_{n}
\end{equation}
and
\begin{equation}
	\vecX_{n+1} = \vecX_{n} + \delta\vecX_{n}.
\end{equation}
This Newton step is to be repeated until
\begin{equation}
	\forall i, \; \vert\delta\vecX_{n,i}\vert \leq \epsilon \times \vert\vecX_{n+1,i}\vert
\end{equation}

\section{Chemical System Initialization}
\subsection{Remaining Degrees of Freedom}
We need $M-N$ supplementary relations to initialize the system. Hopefully, this constraint should be linear
since they shall express the matter conservation, the charge conservation or a fixed concentration.
Let us assume that $\mymat{P}\in\mathcal{M}_{M-N,M}$ is the corresponding "projection" matrix such that
\begin{equation}
	\mymat{P} \vecX = \vec{\Lambda} \in \mathbb{R}^{M-N}.
\end{equation}

\subsection{Legal compositions}
Accordingly, there exist two vectors $\vec{U}\in\mathbb{R}^{M-N}$ and $\vec{V}\in \mathbb{R}^{N}$ of Lagrange multipliers, and
a matrix  $\mymat{Q}\in\mathcal{M}_{N,M}$ such that $\mymat{Q}\in\mymat{P}^\perp$
\begin{equation}
	\vecX = \mytrn{\mymat{P}} \vec{U} + \mytrn{\mymat{Q}}\vec{V}.
\end{equation}
we obtain the "legal" composition of the solution by
\begin{equation}
	\vecX = \vecX^\star + \mytrn{\mymat{Q}}\vec{V}
\end{equation}
with 
\begin{equation}
	\vecX^\star= \underbrace{\mytrn{\mymat{P}} \left(\mymat{P} \mytrn{\mymat{P}}\right)^{-1}}_{\text{Moore-Penrose Pseudo Inverse}} \vec{\Lambda}
\end{equation}

\subsection{Solving}
\subsubsection{Choice of $\mymat{Q}$}
We build an invertible trial matrix
\begin{equation}
	\mymat{F} = 
	\left\lbrack
	\begin{array}{c}
		\mymat{P}\\
		\mymat{Q}_0=\text{rand}(N,M)\\
	\end{array}
	\right\rbrack.
\end{equation}
We perform a Gram-Schmidt orthonormalization of $\mymat{F}$ into
\begin{equation}
	\tilde{\mymat{F}} = 
	\left\lbrack
	\begin{array}{c}
		\tilde{\mymat{P}}\\
		\mymat{Q}=\tilde{\mymat{Q}}_0\\
	\end{array}
	\right\rbrack.
\end{equation}
\subsection{Solving Bis}
We build the initial matrix $\mymat{F}\in\mathcal{M}_{M,M}$
\begin{equation}
	\mymat{F} = 
	\left\lbrack
	\begin{array}{cc}
	\mytrn{\mymat{P}} & \mymat{0} \\
	\end{array}
	\right\rbrack
\end{equation}
and we use a Singular Values Decomposition to obtain a fully
orthonormal matrix
\begin{equation}
	\tilde{\mymat{F}} = 
	\left\lbrack
	\begin{array}{cc}
	\tilde{\mytrn{\mymat{P}}} & \mytrn{\mymat{Q}} \\
	\end{array}
	\right\rbrack
\end{equation}

\subsubsection{Choice of the starting point}
We choose a random $\vec{V}_0$ such as $\vecX_0 = \vecX^\star +  \mytrn{\mymat{Q}}\vec{V}_0$ has a strict majority of
positive values.
The amplitude of the random value
should be around the greatest absolute value of $\vecX^\star$.

\subsubsection{Newton Algorithm Mark-II}
Starting from $\vec{V}_{n}$, we want to find $\delta\vec{V}_n$
\begin{equation}
	\vec{\Gamma}\left(\vecX^\star +  \mytrn{\mymat{Q}}\vec{V}_n + \mytrn{\mymat{Q}}\delta\vec{V}_n\right)
	\simeq \vec{\Gamma}_{n} + \Phi_n  \mytrn{\mymat{Q}} \delta\vec{V}_n
\end{equation}
If $\Phi_n  \mytrn{\mymat{Q}}$ is not invertible then we need to restart from a different initial value.\\
Otherwise, we update $\vec{V}_{n+1}= \vec{V}_{n} + \delta\vec{V}_{n}$.
Since $\mymat{Q}$ is a numerical matrix which has numerical roundoff errors, we shall test the convergence
 on $\delta\vec{V}_{n}$ only and not on the associated $\delta \vecX_n$, that is
we iterate until
\begin{equation}
	\forall i, \; \vert\delta\vec{V}_{n,i}\vert \leq \epsilon \times \vert \vec{V}_{n+1,i}\vert
\end{equation}

The final concentrations must be acceptable. Otherwise,  we have to restart.


\subsubsection{Linear Improvement}
Due to numerical roundoff, $\vecX_n$ maybe not numerically legal.
We iterate the projection
\begin{equation}
	\left\lbrace
	\begin{array}{rcl}
	\delta \vecX_n & = & - \mytrn{\mymat{P}} \left(\mymat{P} \mytrn{\mymat{P}}\right)^{-1} \left( \mymat{P}\vecX_n - \vec{\Lambda} \right)\\
	\vecX_{n+1}    & = & \vecX_n + \delta\vecX_n
	\end{array}
	\right.
\end{equation}
until the numerical limit is reached.

\subsubsection{Final Error Estimation}
Let $\vecX_n$ the set of current values. The the error is about
\begin{equation}
	\delta \vecX_n = \mytrn{\mymat{Q}}\left(\mymat{\Phi}_n\mytrn{\mymat{Q}}\right)^{-1} \vec{\Gamma}_n
\end{equation}
This shall provide the cutoff for small concentrations.


\end{document}
